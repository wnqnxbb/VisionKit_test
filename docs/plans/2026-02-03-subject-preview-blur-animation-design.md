# 自定义相机抠图动效（背景高斯模糊动画）+ 保存主体 + 大图查看（v2 设计）

## 目标
在现有 v1（拍照 -> 自动取最大主体 -> 抠图保存 -> 网格列表）的基础上补齐交互体验：
1. **自定义相机**：使用 `AVCaptureSession` 替代系统相机 UI（`UIImagePickerController`），以便完全控制交互与文案。
2. **拍照后立刻展示抠图动效**：用户点击快门后，仍停留在相机页面，立即开始“背景高斯模糊渐变”动画，同时后台执行主体抠图。
3. **大图查看**：列表网格点击任意主体缩略图，弹出大图查看主体 PNG。
4. **保存主体按钮**：替代系统 “Use Photo”，在抠图完成后提供 `保存主体` / `重拍`；保存后返回列表页。

## 交互流程（自定义相机 + 列表页）
1. 列表页点击“拍照抠主体” -> 打开全屏相机页（自定义 UI）。
2. 相机页（取景态）：
   - 显示实时取景画面 + 一个快门按钮。
3. 用户点击快门：
   - 立即开始背景 blur 动画（0 -> 目标半径），同时显示“识别主体…”状态。
   - 相机页展示已拍摄静帧（freeze frame）作为背景，以保证动效稳定。
   - 后台执行 Vision 抠图（选面积最大主体）。
4. 抠图成功：
   - 在模糊背景上叠加主体 cutout（透明背景，主体淡入）。
   - 显示 `保存主体` / `重拍` 两个按钮。
5. 用户点击：
   - 保存主体：写入本地 PNG + SwiftData 插入记录；自动关闭相机页并返回列表页。
   - 重拍：清空结果与动效，回到取景态继续拍摄。
6. 列表页网格点击：弹出主体大图（sheet）。

## 技术实现要点
- **相机**：
  - `AVCaptureSession` + `AVCaptureDeviceInput` + `AVCapturePhotoOutput`
  - SwiftUI 中用 `AVCaptureVideoPreviewLayer` 封装实时取景（`UIViewRepresentable`）
  - 权限：`AVCaptureDevice.requestAccess(for: .video)`；拒绝时展示引导 UI
- **“背景模糊 + 主体清晰”**：
  - 拍照后使用静帧（`UIImage`）作为底层背景，做 blur 动画
  - 叠加“透明背景主体 cutout”作为上层，保持主体清晰
- **对齐问题**：对拍摄得到的 `UIImage` 做 orientation 归一化（转为 `.up`），并基于归一化后的图像做 Vision 抠图与 UI 展示，确保主体叠加与背景对齐。
- **抠图输出**：
  - 用 `VNGenerateForegroundInstanceMaskRequest` 生成实例 mask，选面积最大的 instance id。
  - 生成两份 cutout：
    - `fullSizeCutout`（与原图同尺寸，透明背景）用于预览叠加。
    - `croppedCutout`（裁切到主体范围）用于保存与列表展示。
- **并发与防串单**：每次拍照生成一个 token；异步抠图/保存完成后仅在 token 匹配时更新 UI，避免连续拍照/重拍时旧结果回写。

## 错误处理
- 相机不可用 / 权限问题：Alert 提示。
- 未识别到主体：Alert 提示，返回取景态，用户可再次拍照。
- 保存失败：Alert 提示，不写入 SwiftData。

## 非目标（v2 不做）
- 手动修边、多主体选择、替换背景、分享、同步到照片库
- 复杂手势缩放/编辑（大图查看仅展示）
